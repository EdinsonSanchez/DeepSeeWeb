/** LightPivotTable
 ** A lightweight pivot table for MDX2JSON source for InterSystems Cache
 ** @author ZitRo
 ** @version 1.0.0-beta.18
 ** @license Apache 2.0
 ** @see https://github.com/ZitRos/LightPivotTable
 **/
LightPivotTable=function(){var DataController=function(t,e){if(e&&"function"!=typeof e)throw new Error("dataChangeTrigger parameter must be a function");this._dataStack=[],this.controller=t,this.pushData(),this.dataChangeTrigger=e,this.SUMMARY_SHOWN=!1};DataController.prototype.isValidData=function(t){return t.dimensions instanceof Array&&t.dimensions[0]instanceof Array&&!t.dimensions[0].length&&(t.dimensions[0]=[{}]),t.dimensions instanceof Array&&t.dimensions[0]instanceof Array&&t.dataArray instanceof Array&&"object"==typeof t.info&&t.info.cubeName},DataController.prototype.pushData=function(){var t;this._dataStack.push(t={data:null,SUMMARY_SHOWN:this.SUMMARY_SHOWN,SORT_STATE:{column:null,order:-1}}),this.SORT_STATE=t.SORT_STATE},DataController.prototype.popData=function(){if(!(this._dataStack.length<2)){var t=this._dataStack[this._dataStack.length-2];this._dataStack.pop(),this.SUMMARY_SHOWN=t.SUMMARY_SHOWN,this.SORT_STATE=t.SORT_STATE}},DataController.prototype.getData=function(){return this._dataStack[this._dataStack.length-1].data},DataController.prototype.setData=function(t){var e=this;return this.isValidData(t)?(this._dataStack[this._dataStack.length-1].data=t,this.resetDimensionProps(),this.resetConditionalFormatting(),this.resetRawData(),"drillthrough"===t.info.mdxType&&this.setDrillThroughHandler(function(t){return e.controller.pivotView.displayMessage(t.cellData.value||"",!0),!1}),this._trigger(),t):void console.error("Invalid data to set.",t)},DataController.prototype.setDrillThroughHandler=function(t){this._dataStack[this._dataStack.length-1].data.info.drillThroughHandler=t},DataController.prototype.resetDimensionProps=function(){var t,e=[];if(!(t=this._dataStack[this._dataStack.length-1].data))return void console.error("Unable to get dimension props for given data set.");var r=function(t){var e,r={};for(e in t)r[e]=t[e];return r},a=function(t,o){var n,i,l;if(t.children&&t.children.length>0)for(l in t.children)i=r(o),n=t.children[l],n.format&&(i.format=n.format),n.style&&(i.style=(i.style||"")+n.style),n.summary&&(i.summary=n.summary),n.type&&(i.type=n.type),a(n,i);else i=r(o),e.push(i)};a({children:t.dimensions[0]},{}),t.columnProps=e},DataController.prototype.resetConditionalFormatting=function(){var t,e,r,a,o,n,i,l,s={};if(!(t=this._dataStack[this._dataStack.length-1].data))return void console.error("Unable to get conditional formatting for given data set.");if(!this.controller.CONFIG.pivotProperties)return void(t.conditionalFormatting=s);(e=this.controller.CONFIG.pivotProperties.colorScale)&&(e.indexOf("custom:")>-1?(o=e.split(":")[1].split(","),a={r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2])},o=e.split(":")[2].split(","),r={r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2])}):(o=e.split("-to-"),r=this.controller.pivotView.colorNameToRGB(o[0]),a=this.controller.pivotView.colorNameToRGB(o[1])),s.colorScale={from:a,to:r,min:n=Math.min.apply(Math,t.dataArray||[]),max:i=Math.max.apply(Math,t.dataArray||[]),diff:i-n,invert:(a.r+a.b+a.g)/3<128}),l=this.controller.CONFIG.pivotProperties.formatRules||[],l.length&&"undefined"==typeof this.controller.CONFIG.conditionalFormattingOn&&(this.controller.CONFIG.conditionalFormattingOn=!0);for(var c in l)s[l[c].range]||(s[l[c].range]=[]),s[l[c].range].push(l[c]);t.conditionalFormatting=s},DataController.prototype.TOTAL_FUNCTIONS={totalSUM:function(t,e,r,a){for(var o=0,n=e;r>n;n++)isFinite(t[n][a].value)&&(o+=parseFloat(t[n][a].value)||0);return o},totalAVG:function(t,e,r,a){for(var o=0,n=e;r>n;n++){if(!isFinite(t[n][a].value)){o=0;break}o+=parseFloat(t[n][a].value)||0}return o/(r-e)||""},totalCOUNT:function(t,e,r){return r-e},totalMIN:function(t,e,r,a){for(var o=1/0,n=e;r>n;n++)isFinite(t[n][a].value)&&t[n][a].value<o&&(o=t[n][a].value);return o},totalMAX:function(t,e,r,a){for(var o=-1/0,n=e;r>n;n++)isFinite(t[n][a].value)&&t[n][a].value>o&&(o=t[n][a].value);return o},totalPERCENTAGE:function(t,e,r,a,o){var n,i,l=[];for(n=o;n<t[0].length;n++)l.push(this.totalSUM(t,e,r,n));return i=l.reduce(function(t,e){return t+e}),(l[a-o]/i*100||0).toFixed(2)+"%"},totalNONE:function(){return""}},DataController.prototype.resetRawData=function(){var t,e,r,a,o,n=this;if(!(t=this._dataStack[this._dataStack.length-1].data))return console.error("Unable to create raw data for given data set."),null;var i=[],l=[],s=2,c=[],h=function(t){return Object.keys(t[0]).map(function(e){return t.map(function(t){return t[e]})})},u=function(t,e,r){d(i,e,r,!0);var a,o=0;for(a in i)i[a].length>o&&(o=i[a].length);for(a in i)for(var n=i[a].length;o>n;n++)i[a].push(i[a][i[a].length-1]);i=h(i)},p=function(t,e){n.controller.CONFIG.pivotProperties&&(n.controller.CONFIG.pivotProperties.columnHeaderStyle&&e?t.style=n.controller.CONFIG.pivotProperties.columnHeaderStyle:n.controller.CONFIG.pivotProperties.rowHeaderStyle&&!e&&(t.style=n.controller.CONFIG.pivotProperties.rowHeaderStyle))},d=function(t,e,r,a){r||(r=[]);var o,n;for(var i in e)o=s,e[i].children&&e[i].children.length?(s++,n={group:o,source:e[i],isCaption:!0,value:e[i].caption||""},p(n,a),d(t,e[i].children,r.concat(n),a)):(n={group:s,source:e[i],isCaption:!0,value:e[i].caption||""},p(n,a),t.push(r.concat(n)),s++)},f=function(t){if(!n.controller.CONFIG.pivotProperties)return t;var e,r,a,o=t[0].length,i=n.controller.getPivotProperty(["columnLevels"]),l={},s=function(t){if("undefined"!=typeof t)for(var e in t.childLevels)t.childLevels[e].spec&&t.childLevels[e].levelStyle&&(l[t.childLevels[e].spec]={style:t.childLevels[e].levelStyle}),s(t.childLevels[e])};for(a in i)s(i[a]);for(r=0;r<t.length;r++)for(e=0;o>e;e++){if(!t[r][e].isCaption){o=e;break}if(t[r][e].source&&t[r][e].source.path)for(a in l)if(t[r][e].source.path.indexOf(a)>=0){for(var c=r+1;c<t.length;c++)t[c][e].isCaption||(t[c][e].style=(t[c][e].style||"")+l[a].style||"");break}}return t};t.dimensions[0].length&&u(i,t.dimensions[0]),t.dimensions[1].length&&d(l,t.dimensions[1]),l[0]&&(o=(l[0][l[0].length-1]||{source:{}}).source.dimension);var m=(i[0]||[]).length,g=l.length||t.info.rowCount||0,v=i.length||t.info.colCount||0,S=(l[0]||[]).length,C=!!this.controller.CONFIG.attachTotals;for(r=0;v+g>r;r++)for(c[r]||(c[r]=[]),a=0;S+m>a;a++)S>a?v>r?(c[r][a]={group:1,isCaption:!0,value:this.controller.CONFIG.caption||o||(t.info||{}).cubeName||""},p(c[r][a],!1)):c[r][a]=l[r-v][a]:c[r][a]=v>r?i[r][a-S]:{value:t.dataArray[m*(r-v)+a-S]||""};t.info.topHeaderRowsNumber=v,t.info.SUMMARY_SHOWN=!1,t.info.leftHeaderColumnsNumber=S,this.SUMMARY_SHOWN=!1,this._dataStack[this._dataStack.length-1].SUMMARY_SHOWN=!1;var N=function(e){var r=n.controller.getPivotProperty(["rowTotalAgg"]);if(!t.columnProps[e]&&!r)return n.TOTAL_FUNCTIONS.totalSUM;switch(t.columnProps[e].summary||r){case"count":return n.TOTAL_FUNCTIONS.totalCOUNT;case"avg":return n.TOTAL_FUNCTIONS.totalAVG;case"min":return n.TOTAL_FUNCTIONS.totalMIN;case"max":return n.TOTAL_FUNCTIONS.totalMAX;case"pct":return n.TOTAL_FUNCTIONS.totalPERCENTAGE;case"none":return n.TOTAL_FUNCTIONS.totalNONE;default:return n.TOTAL_FUNCTIONS.totalSUM}};if(this.controller.CONFIG.showSummary&&c.length-v>1&&(c[c.length-1][0]||{}).isCaption){t.info.SUMMARY_SHOWN=!0,this.SUMMARY_SHOWN=!0,this._dataStack[this._dataStack.length-1].SUMMARY_SHOWN=!0,e=[],a=c.length-2;for(var y in c[a])c[a][y].isCaption?(e[y]={group:s,isCaption:!0,source:{},noDrillDown:!0,value:pivotLocale.get(0)},p(e[y],!1)):e[y]={value:N(parseInt(y)-t.info.leftHeaderColumnsNumber).call(this.TOTAL_FUNCTIONS,c,v,c.length,y,t.info.leftHeaderColumnsNumber),style:"font-weight: bold;text-align: right;"};s++,C?(c.splice(t.info.topHeaderRowsNumber,0,e),t.info.topHeaderRowsNumber++):c.push(e)}return c=f(c),t.rawData=t._rawDataOrigin=c,t.rawData},DataController.prototype._trigger=function(){this.dataChangeTrigger&&this.dataChangeTrigger()},DataController.prototype.sortByColumn=function(t){var e=this._dataStack[this._dataStack.length-1].data,r=this.SUMMARY_SHOWN&&this.controller.CONFIG.attachTotals?1:0;this.SORT_STATE.column!==t&&(n=this.SORT_STATE.order=0);var a=e._rawDataOrigin.slice(e.info.topHeaderRowsNumber,e._rawDataOrigin.length-(this.SUMMARY_SHOWN&&!r?1:0)),o=e.info.leftHeaderColumnsNumber+t,n=-1===this.SORT_STATE.order?1:1===this.SORT_STATE.order?0:-1;this.SORT_STATE.order=n,this.SORT_STATE.column=t;for(var i in e.rawData[e.info.topHeaderRowsNumber-r-1])e.rawData[e.info.topHeaderRowsNumber-r-1][i].className&&delete e.rawData[e.info.topHeaderRowsNumber-r-1][i].className;return 0===n?(e.rawData=e._rawDataOrigin,void this._trigger()):(n=-n,a.sort(function(t,e){return e[o].value>t[o].value?n:e[o].value<t[o].value?-n:0}),e.rawData=e._rawDataOrigin.slice(0,e.info.topHeaderRowsNumber).concat(a).concat(this.SUMMARY_SHOWN&&!r?[e._rawDataOrigin[e._rawDataOrigin.length-1]]:[]),e.rawData[e.info.topHeaderRowsNumber-r-1][e.info.leftHeaderColumnsNumber+t].className=0===n?"":1===n?"lpt-sortDesc":"lpt-sortAsc",void this._trigger())},DataController.prototype.filterByValue=function(t,e){var r=this._dataStack[this._dataStack.length-1].data,a=this.SUMMARY_SHOWN&&this.controller.CONFIG.attachTotals?1:0,o=r._rawDataOrigin.slice(r.info.topHeaderRowsNumber,r._rawDataOrigin.length-(this.SUMMARY_SHOWN&&!a?1:0)),n=null;try{n=new RegExp(t,"i")}catch(i){try{n=new RegExp(t.replace(/([()[{*+.$^\\|?])/g,"\\$1"),"i")}catch(i){return}}o=o.filter(function(t){return(t[e].value||"").toString().match(n)}),r.rawData=r._rawDataOrigin.slice(0,r.info.topHeaderRowsNumber).concat(o).concat(this.SUMMARY_SHOWN&&!a?[r._rawDataOrigin[r._rawDataOrigin.length-1]]:[]),this._trigger()};var DataSource=function(t,e,r){this.SOURCE_URL=t.MDX2JSONSource||location.host+":"+location.port+"/"+(location.pathname.split("/")||[])[1],this.NAMESPACE=t.namespace,this.USERNAME=t.username,this.PASSWORD=t.password,this.LPT=r,this.GLOBAL_CONFIG=e,this.SEND_COOKIES=t.sendCookies||!1,this.BASIC_MDX=t.basicMDX,this.DATA_SOURCE_PIVOT=t.pivot||"",this.FILTERS=[]};DataSource.prototype._post=function(url,data,callback){var xhr=new XMLHttpRequest;xhr.open("POST",url),this.SEND_COOKIES&&(xhr.withCredentials=!0),xhr.onreadystatechange=function(){4===xhr.readyState&&200===xhr.status?callback(function(){try{return JSON.parse(xhr.responseText)||{}}catch(e){try{var temp=null;return eval("temp="+xhr.responseText),temp}catch(e){return{error:"<h1>Unable to parse server response</h1><p>"+xhr.responseText+"</p>"}}}}()):4===xhr.readyState&&200!==xhr.status&&callback({error:xhr.responseText||pivotLocale.get(3)+"<br/>"+xhr.status+": "+xhr.statusText})},this.USERNAME&&this.PASSWORD&&xhr.setRequestHeader("Authorization","Basic "+btoa(this.USERNAME+":"+this.PASSWORD)),xhr.send(JSON.stringify(data))},DataSource.prototype._convert=function(t){var e;if("object"!=typeof t||t.error)return{error:t.error||!0};try{return e={dimensions:[t.Cols[0].tuples,t.Cols[1].tuples],dataArray:t.Data,info:t.Info}}catch(r){return console.error("Error while parsing data:",r),{error:t.error||!0}}},DataSource.prototype.setFilter=function(t){this.FILTERS.push(t)},DataSource.prototype.clearFilters=function(){this.FILTERS=[]},DataSource.prototype.getCurrentData=function(t){for(var e=this,r=this._convert,a=this.BASIC_MDX,o=new MDXParser,n=o.mdxType(a),i={state:0,data:{},pivotData:{}},l=0;l<this.FILTERS.length;l++)a=o.applyFilter(a,this.FILTERS[l]);var s=function(){var t=i.pivotData;e.GLOBAL_CONFIG.pivotProperties=i.pivotData,t.rowAxisOptions&&(t.rowAxisOptions.drilldownSpec&&(e.GLOBAL_CONFIG.DrillDownExpression=e.GLOBAL_CONFIG.DrillDownExpression||t.rowAxisOptions.drilldownSpec.split("^")),(t.rowAxisOptions.levelFormat||t.columnAxisOptions&&t.columnAxisOptions.levelFormat)&&(e.GLOBAL_CONFIG.formatNumbers=e.GLOBAL_CONFIG.formatNumbers||t.columnAxisOptions.levelFormat||t.rowAxisOptions.levelFormat))},c=function(){var o=i.data;t("drillthrough"===n?function(t){var e,a,o,i=t.children||[],l=[];if(!i.length)return{error:"No DrillThrough data."};for(a in i[0])l.push({caption:a});e={Cols:[{tuples:l},{tuples:[]}],Data:[],Info:{colCount:8,cubeClass:"No cube class",cubeName:"No cube name",leftHeaderColumnsNumber:0,rowCount:i.length,topHeaderRowsNumber:l.length,mdxType:n}};for(a in i)for(o in i[a])e.Data.push(i[a][o]);return r(e)}(o):"mdx"===n?e._convert(o):{error:"Unrecognised MDX: "+a||!0})},h=function(){console.log("LPT MDX request:",a),e._post(e.SOURCE_URL+"/"+("drillthrough"===n?"MDXDrillthrough":"MDX")+(e.NAMESPACE?"?Namespace="+e.NAMESPACE:""),{MDX:a},function(t){e.LPT.pivotView.removeMessage(),i.data=t,i.state++,c()})};e.LPT.pivotView.displayLoading(),this.DATA_SOURCE_PIVOT?this._post(this.SOURCE_URL+"/DataSource"+(e.NAMESPACE?"?Namespace="+e.NAMESPACE:""),{DataSource:this.DATA_SOURCE_PIVOT},function(t){i.pivotData=t,i.state++,s(),h()}):h()};var ExcelExport=function(){};ExcelExport.prototype.exportTableHTML=function(){var t="data:application/vnd.ms-excel;base64,",e='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>',r=function(t){return window.btoa(unescape(encodeURIComponent(t)))},a=function(t,e){return t.replace(/{(\w+)}/g,function(t,r){return e[r]})};return function(o,n){var i={worksheet:n||"Worksheet",table:o};console.log(t+r(a(e,i))),window.location.href=t+r(a(e,i))}}(),ExcelExport.prototype.exportXLS=function(){var t=document.getElementsByClassName("lpt")[0],e=t.getElementsByClassName("lpt-tableBlock")[0].getElementsByTagName("table")[0].innerHTML,r=t.getElementsByClassName("lpt-topHeader")[0].getElementsByTagName("table")[0].innerHTML.replace(/<tr>/,"<tr><th colspan='2'></th>"),a=t.getElementsByClassName("lpt-leftHeader")[0].getElementsByTagName("thead")[0].innerHTML,o=a.match("<tr>(.*)</tr>")[1].split("</tr><tr>"),n=0;e=e.replace(/<tr>/g,function(){return"<tr>"+o[n++]}),console.log(r+e),this.exportTableHTML(r+e,"test")};var LightPivotTable=function(t){var e=this;"object"!=typeof t&&(t={}),this.normalizeConfiguration(t),this._dataSourcesStack=[],this.DRILL_LEVEL=-1,this.CONFIG=t,this.VERSION="".concat("1.0.0-beta.18")||"[NotBuilt]",this.CONTROLS={},this.mdxParser=new MDXParser,this.pivotView=new PivotView(this,t.container),this.dataSource=this.pushDataSource(t.dataSource),this.dataController=new DataController(this,function(){e.dataIsChanged.call(e)}),this.init()};LightPivotTable.prototype.refresh=function(){var t,e=this;if(this.clearFilters(),this.CONFIG.defaultFilterSpecs instanceof Array)for(t in this.CONFIG.defaultFilterSpecs)this.setFilter(this.CONFIG.defaultFilterSpecs[t]);this.dataSource.getCurrentData(function(t){e.dataController.isValidData(t)?e.dataController.setData(t):e.pivotView.displayMessage(t.error||pivotLocale.get(2))})},LightPivotTable.prototype.changeBasicMDX=function(t){for(var e=this._dataSourcesStack.length-1;e>0;e--)this.popDataSource(),this.pivotView.popTable(),this.dataController.popData();this.CONFIG.dataSource.basicMDX=t,this.dataSource.BASIC_MDX=t,this.refresh()},LightPivotTable.prototype.getActualMDX=function(){var t=this.CONFIG.dataSource.basicMDX,e=new MDXParser,r=this.dataSource.FILTERS;for(var a in r)t=e.applyFilter(t,r[a]);return t},LightPivotTable.prototype.updateSizes=function(){this.pivotView.updateSizes()},LightPivotTable.prototype.setFilter=function(t){this.dataSource.setFilter(t)},LightPivotTable.prototype.clearFilters=function(){this.dataSource.clearFilters()},LightPivotTable.prototype.pushDataSource=function(t){var e;return this.DRILL_LEVEL++,this._dataSourcesStack.push(e=new DataSource(t||{},this.CONFIG,this)),this.dataSource=e,e},LightPivotTable.prototype.popDataSource=function(t){this._dataSourcesStack.length<2||(this.DRILL_LEVEL--,this._dataSourcesStack.pop(),t||this.dataController.popData(),this.dataSource=this._dataSourcesStack[this._dataSourcesStack.length-1])},LightPivotTable.prototype.dataIsChanged=function(){this.pivotView.dataChanged(this.dataController.getData())},LightPivotTable.prototype.tryDrillDown=function(t){var e,r=this,a={};for(var o in r.CONFIG.dataSource)a[o]=r.CONFIG.dataSource[o];!this.CONFIG.DrillDownExpression||this.CONFIG.DrillDownExpression instanceof Array||(this.CONFIG.DrillDownExpression=[this.CONFIG.DrillDownExpression]),a.basicMDX=(this.CONFIG.DrillDownExpression||[])[this.DRILL_LEVEL]?this.mdxParser.drillDown(this.dataSource.BASIC_MDX,t,this.CONFIG.DrillDownExpression[this.DRILL_LEVEL])||this.dataSource.BASIC_MDX:this.mdxParser.drillDown(this.dataSource.BASIC_MDX,t)||this.dataSource.BASIC_MDX,e=this.dataSource,this.pushDataSource(a),this.dataSource.FILTERS=e.FILTERS,this.dataSource.getCurrentData(function(t){r.dataController.isValidData(t)&&t.dataArray.length>0&&t.dimensions[1]&&t.dimensions[1][0]&&(t.dimensions[1][0].caption||t.dimensions[1][0].dimension||t.dimensions[1][0].path)?(r.pivotView.pushTable(),r.dataController.pushData(),r.dataController.setData(t),"function"==typeof r.CONFIG.triggers.drillDown&&r.CONFIG.triggers.drillDown.call(r,{level:r.DRILL_LEVEL,mdx:a.basicMDX})):r.popDataSource(!0)})},LightPivotTable.prototype.tryDrillThrough=function(t){var e,r=this,a={};for(var o in r.CONFIG.dataSource)a[o]=r.CONFIG.dataSource[o];a.basicMDX=this.mdxParser.drillThrough(this.dataSource.BASIC_MDX,t)||this.dataSource.basicMDX,e=this.dataSource,this.pushDataSource(a),this.dataSource.FILTERS=e.FILTERS,this.dataSource.getCurrentData(function(t){r.dataController.isValidData(t)&&t.dataArray.length>0?(r.pivotView.pushTable({disableConditionalFormatting:!0}),r.dataController.pushData(),r.dataController.setData(t),"function"==typeof r.CONFIG.triggers.drillThrough&&r.CONFIG.triggers.drillThrough.call(r,{level:r.DRILL_LEVEL,mdx:a.basicMDX})):r.popDataSource(!0)})},LightPivotTable.prototype.getPivotProperty=function(t){if(!this.CONFIG.pivotProperties)return void 0;t instanceof Array||(t=[]);var e=this.CONFIG.pivotProperties;for(t=t.reverse();t.length&&"undefined"!=typeof e;)e=e[t.pop()];return e},LightPivotTable.prototype.normalizeConfiguration=function(t){"undefined"==typeof t.columnResizing&&(t.columnResizing=!0),"undefined"==typeof t.pagination&&(t.pagination=200),"undefined"==typeof t.enableSearch&&(t.enableSearch=!0),"undefined"==typeof t.stretchColumns&&(t.stretchColumns=!0),t.triggers||(t.triggers={}),t.dataSource||(t.dataSource={})},LightPivotTable.prototype.init=function(){var t=this;this.CONTROLS.drillThrough=function(){t.pivotView._drillThroughClickHandler.call(t.pivotView)},this.CONTROLS.customDrillThrough=function(e){return e instanceof Array?void t.tryDrillThrough.call(t,e):void console.error('Parameter "filters" must be array of strings.')},this.CONTROLS.back=function(){t.pivotView._backClickHandler.call(t.pivotView)},this.CONFIG.locale&&pivotLocale.setLocale(this.CONFIG.locale),this.refresh()};var MDXParser=function(){};MDXParser.prototype._warnMDX=function(t,e){console.warn("MDX is not parsed:\n\n%s\n\n"+(e?"("+e+")":""),t)},MDXParser.prototype.makeSetExpressionFromFilter=function(t){return t.match(/^\([^\),]*,[^\)]*\)$/)?"NONEMPTYCROSSJOIN"+t.slice(0,t.length-1)+".children)":t+".children"},MDXParser.prototype.prependNonEmpty=function(t){return t.match(/^\s*non\s+empty/i)?t:"NON EMPTY "+t},MDXParser.prototype.drillDown=function(t,e,r){if(!e)return this._warnMDX(t,"no filter specified"),"";var a=t.split(/(select\s*)(.*?)(\s*from)/gi);if(a.length<4)return this._warnMDX(t),"";var o=a[a.length-3],n=o.split(/(\s*ON\s*[01]\s*,?\s*)/);if(n.length<2)return this._warnMDX(t),"";var i=-1;if(n.map(function(t,e){return t.match(/\s*ON\s*[01]\s*,?\s*/)&&(i=e-1),t}),-1===i)return this._warnMDX(t,"DrillDown is impossible"),"";n[i]=this.prependNonEmpty(r||this.makeSetExpressionFromFilter(e));for(var l in n)1===n[l].length&&n[l](parseInt(l),1);return a[a.length-3]=n.join(""),this.applyFilter(a.join(""),e)},MDXParser.prototype.drillThrough=function(t,e){var r=t.split(/(FROM\s*\[[^\]]*].*)/i)[1],a="DRILLTHROUGH SELECT "+r;for(var o in e)a=this.applyFilter(a,e[o]);return a},MDXParser.prototype.mdxType=function(t){var e=t.toLowerCase(),r=e.indexOf("drillthrough"),a=e.indexOf("select");return r>-1?"drillthrough":a>-1?"mdx":"unknown"},MDXParser.prototype.applyFilter=function(t,e){return t+" %FILTER "+e};var numeral=function(){function t(t){this._value=t}function e(t,e,r,a){var o,n,i=Math.pow(10,e);return n=(r(t*i)/i).toFixed(e),a&&(o=new RegExp("0{1,"+a+"}$"),n=n.replace(o,"")),n}function r(t,e,r){var a;return a=e.indexOf("$")>-1?o(t,e,r):e.indexOf("%")>-1?n(t,e,r):e.indexOf(":")>-1?i(t,e):s(t._value,e,r)}function a(t,e){var r,a,o,n,i,s=e,c=["KB","MB","GB","TB","PB","EB","ZB","YB"],h=!1;if(e.indexOf(":")>-1)t._value=l(e);else if(e===g)t._value=0;else{for("."!==f[m].delimiters.decimal&&(e=e.replace(/\./g,"").replace(f[m].delimiters.decimal,".")),r=new RegExp("[^a-zA-Z]"+f[m].abbreviations.thousand+"(?:\\)|(\\"+f[m].currency.symbol+")?(?:\\))?)?$"),a=new RegExp("[^a-zA-Z]"+f[m].abbreviations.million+"(?:\\)|(\\"+f[m].currency.symbol+")?(?:\\))?)?$"),o=new RegExp("[^a-zA-Z]"+f[m].abbreviations.billion+"(?:\\)|(\\"+f[m].currency.symbol+")?(?:\\))?)?$"),n=new RegExp("[^a-zA-Z]"+f[m].abbreviations.trillion+"(?:\\)|(\\"+f[m].currency.symbol+")?(?:\\))?)?$"),i=0;i<=c.length&&!(h=e.indexOf(c[i])>-1?Math.pow(1024,i+1):!1);i++);t._value=(h?h:1)*(s.match(r)?Math.pow(10,3):1)*(s.match(a)?Math.pow(10,6):1)*(s.match(o)?Math.pow(10,9):1)*(s.match(n)?Math.pow(10,12):1)*(e.indexOf("%")>-1?.01:1)*((e.split("-").length+Math.min(e.split("(").length-1,e.split(")").length-1))%2?1:-1)*Number(e.replace(/[^0-9\.]+/g,"")),t._value=h?Math.ceil(t._value):t._value}return t._value}function o(t,e,r){var a,o,n=e.indexOf("$"),i=e.indexOf("("),l=e.indexOf("-"),c="";return e.indexOf(" $")>-1?(c=" ",e=e.replace(" $","")):e.indexOf("$ ")>-1?(c=" ",e=e.replace("$ ","")):e=e.replace("$",""),o=s(t._value,e,r),1>=n?o.indexOf("(")>-1||o.indexOf("-")>-1?(o=o.split(""),a=1,(i>n||l>n)&&(a=0),o.splice(a,0,f[m].currency.symbol+c),o=o.join("")):o=f[m].currency.symbol+c+o:o.indexOf(")")>-1?(o=o.split(""),o.splice(-1,0,c+f[m].currency.symbol),o=o.join("")):o=o+c+f[m].currency.symbol,o}function n(t,e,r){var a,o="",n=100*t._value;return e.indexOf(" %")>-1?(o=" ",e=e.replace(" %","")):e=e.replace("%",""),a=s(n,e,r),a.indexOf(")")>-1?(a=a.split(""),a.splice(-1,0,o+"%"),a=a.join("")):a=a+o+"%",a}function i(t){var e=Math.floor(t._value/60/60),r=Math.floor((t._value-60*e*60)/60),a=Math.round(t._value-60*e*60-60*r);return e+":"+(10>r?"0"+r:r)+":"+(10>a?"0"+a:a)}function l(t){var e=t.split(":"),r=0;return 3===e.length?(r+=60*Number(e[0])*60,r+=60*Number(e[1]),r+=Number(e[2])):2===e.length&&(r+=60*Number(e[0]),r+=Number(e[1])),Number(r)}function s(t,r,a){var o,n,i,l,s,c,h=!1,u=!1,p=!1,d="",v=!1,S=!1,O=!1,b=!1,E=!1,_="",w="",T=Math.abs(t),D=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],L="",I=!1;if(0===t&&null!==g)return g;if(r.indexOf("(")>-1?(h=!0,r=r.slice(1,-1)):r.indexOf("+")>-1&&(u=!0,r=r.replace(/\+/g,"")),r.indexOf("a")>-1&&(v=r.indexOf("aK")>=0,S=r.indexOf("aM")>=0,O=r.indexOf("aB")>=0,b=r.indexOf("aT")>=0,E=v||S||O||b,r.indexOf(" a")>-1?(d=" ",r=r.replace(" a","")):r=r.replace("a",""),T>=Math.pow(10,12)&&!E||b?(d+=f[m].abbreviations.trillion,t/=Math.pow(10,12)):T<Math.pow(10,12)&&T>=Math.pow(10,9)&&!E||O?(d+=f[m].abbreviations.billion,t/=Math.pow(10,9)):T<Math.pow(10,9)&&T>=Math.pow(10,6)&&!E||S?(d+=f[m].abbreviations.million,t/=Math.pow(10,6)):(T<Math.pow(10,6)&&T>=Math.pow(10,3)&&!E||v)&&(d+=f[m].abbreviations.thousand,t/=Math.pow(10,3))),r.indexOf("b")>-1)for(r.indexOf(" b")>-1?(_=" ",r=r.replace(" b","")):r=r.replace("b",""),i=0;i<=D.length;i++)if(o=Math.pow(1024,i),n=Math.pow(1024,i+1),t>=o&&n>t){_+=D[i],o>0&&(t/=o);break}return r.indexOf("o")>-1&&(r.indexOf(" o")>-1?(w=" ",r=r.replace(" o","")):r=r.replace("o",""),w+=f[m].ordinal(t)),r.indexOf("[.]")>-1&&(p=!0,r=r.replace("[.]",".")),l=t.toString().split(".")[0],s=r.split(".")[1],c=r.indexOf(","),s?(s.indexOf("[")>-1?(s=s.replace("]",""),s=s.split("["),L=e(t,s[0].length+s[1].length,a,s[1].length)):L=e(t,s.length,a),l=L.split(".")[0],L=L.split(".")[1].length?(N||f[m].delimiters.decimal)+L.split(".")[1]:"",p&&0===Number(L.slice(1))&&(L="")):l=e(t,null,a),l.indexOf("-")>-1&&(l=l.slice(1),I=!0),c>-1&&(l=l.toString().replace(y,"$1"+(C||f[m].delimiters.thousands))),0===r.indexOf(".")&&(l=""),(h&&I?"(":"")+(!h&&I?"-":"")+(!I&&u?"+":"")+l+L+(w?w:"")+(d?d:"")+(_?_:"")+(h&&I?")":"")}function c(t,e){f[t]=e}function h(t){var e=t.toString().split(".");return e.length<2?1:Math.pow(10,e[1].length)}function u(){var t=Array.prototype.slice.call(arguments);return t.reduce(function(t,e){var r=h(t),a=h(e);return r>a?r:a},-1/0)}var p,d="1.5.3",f={},m="en",g=null,v="0,0",S=3,C=",",N=".",y=new RegExp("(\\d)(?=(\\d{"+S+"})+(?!\\d))","g");p=function(e){return p.isNumeral(e)?e=e.value():0===e||"undefined"==typeof e?e=0:Number(e)||(e=p.fn.unformat(e)),new t(Number(e))},p.version=d,p.isNumeral=function(e){return e instanceof t},p.language=function(t,e){if(!t)return m;if(t&&!e){if(!f[t])throw new Error("Unknown language : "+t);m=t}return(e||!f[t])&&c(t,e),p},p.languageData=function(t){if(!t)return f[m];if(!f[t])throw new Error("Unknown language : "+t);return f[t]},p.language("en",{delimiters:{thousands:",",decimal:"."},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(t){var e=t%10;return 1===~~(t%100/10)?"th":1===e?"st":2===e?"nd":3===e?"rd":"th"},currency:{symbol:"$"}}),p.zeroFormat=function(t){g="string"==typeof t?t:null},p.defaultFormat=function(t){v="string"==typeof t?t:"0.0"},"function"!=typeof Array.prototype.reduce&&(Array.prototype.reduce=function(t,e){"use strict";if(null===this||"undefined"==typeof this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof t)throw new TypeError(t+" is not a function");var r,a,o=this.length>>>0,n=!1;for(1<arguments.length&&(a=e,n=!0),r=0;o>r;++r)this.hasOwnProperty(r)&&(n?a=t(a,this[r],r,this):(a=this[r],n=!0));if(!n)throw new TypeError("Reduce of empty array with no initial value");return a}),p.setup=function(t,e,r){t!==N&&(N=t),e!==C&&(C=e),r!==S&&(S=r,y=new RegExp("(\\d)(?=(\\d{"+S+"})+(?!\\d))","g"))},p.fn=t.prototype={clone:function(){return p(this)},format:function(t,e){return r(this,t?t:v,void 0!==e?e:Math.round)},unformat:function(t){return"[object Number]"===Object.prototype.toString.call(t)?t:a(this,t?t:v)},value:function(){return this._value},valueOf:function(){return this._value},set:function(t){return this._value=Number(t),this},add:function(t){function e(t,e){return t+r*e}var r=u.call(null,this._value,t);return this._value=[this._value,t].reduce(e,0)/r,this},subtract:function(t){function e(t,e){return t-r*e}var r=u.call(null,this._value,t);return this._value=[t].reduce(e,this._value*r)/r,this},multiply:function(t){function e(t,e){var r=u(t,e);return t*r*e*r/(r*r)}return this._value=[this._value,t].reduce(e,1),this},divide:function(t){function e(t,e){var r=u(t,e);return t*r/(e*r)}return this._value=[this._value,t].reduce(e),this},difference:function(t){return Math.abs(p(this._value).subtract(t).value())}},this.numeral=p},PivotLocale=function(t){this.LOCALE="",this.DEFAULT_LOCALE="en",this.setLocale(t||(navigator.language||"").substr(0,2)||(navigator.browserLanguage||this.DEFAULT_LOCALE).substring(0,2))};PivotLocale.prototype.LOCALES=[{ru:"\u0412\u0441\u0435\u0433\u043e",en:"Total",de:"Summe"},{ru:"\u041d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u043e\u0442\u043e\u0431\u0440\u0430\u0437\u0438\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435",en:"Unable to render data",de:"Daten k\xf6nnen nicht rendern"},{ru:"\u041d\u0435\u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u0434\u043b\u044f \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f.",en:"Invalid data to display.",de:"Nicht korrekt Informationen angezeigt werden soll."},{ru:"\u0412\u043e\u0437\u043d\u0438\u043a\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0438 \u0434\u0430\u043d\u043d\u044b\u0445 \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u0430.",en:"Error while trying to retrieve data from server.",de:"Beim Abrufen der Daten vom Server ist ein Fehler aufgetreten."}],PivotLocale.prototype.setLocale=function(t){var e,r=[];if(t=t.toLowerCase(),this.LOCALES[0].hasOwnProperty(t))this.LOCALE=t;else{for(e in this.LOCALES[0])r.push(e);console.warn("LightPivot: locale "+t+" is not supported. Currently localized: "+r.join(", ")+"."),this.LOCALE="en"}},PivotLocale.prototype.get=function(t){return(this.LOCALES[t]||{})[this.LOCALE]||"{not localized}"};var pivotLocale=new PivotLocale,PivotView=function(t,e){if(!(e instanceof HTMLElement))throw new Error('Please, provide HTMLElement instance "container" into pivot table configuration.');this.tablesStack=[],numeral.call(this),this.elements={container:e,base:document.createElement("div"),tableContainer:void 0,messageElement:void 0,searchSelect:void 0,searchInput:void 0},this.pagination=null,this.savedScroll={x:0,y:0},this.FIXED_COLUMN_SIZES=[],this.PAGINATION_BLOCK_HEIGHT=20,this.ANIMATION_TIMEOUT=500,this.SEARCH_ENABLED=!1,this.SEARCHBOX_LEFT_MARGIN=191,this.savedSearch={restore:!1,value:"",columnIndex:0},this.controller=t,this.SCROLLBAR_WIDTH=function(){var t=document.createElement("div");t.style.visibility="hidden",t.style.width="100px",t.style.msOverflowStyle="scrollbar",document.body.appendChild(t);var e=t.offsetWidth;t.style.overflow="scroll";var r=document.createElement("div");r.style.width="100%",t.appendChild(r);var a=r.offsetWidth;return t.parentNode.removeChild(t),e-a}(),this.init()};return PivotView.prototype.init=function(){var t=this,e=this.elements;e.base.className="lpt",e.container.appendChild(e.base),this.pushTable(),this.displayLoading(),window.addEventListener("resize",function(){t.updateSizes.call(t)}),this._=function(){t.displayMessage('<a href="https://github.com/ZitRos/LightPivotTable">LIGHT PIVOT TABLE v'+t.controller.VERSION+'</a><br/>by <a href="https://plus.google.com/+NikitaSavchenko">Nikita Savchenko</a><br/>for dear users of products of <a href="http://www.intersystems.com/">InterSystems Corporation</a><br/>Hope you enjoy it!',!0)
}},PivotView.prototype.displayLoading=function(){this.displayMessage(this.controller.CONFIG.loadingMessageHTML||'<div class="lpt-spinner"><div></div><div></div><div></div><div></div><div></div></div>')},PivotView.prototype.updateSizes=function(){for(var t in this.tablesStack)this.recalculateSizes(this.tablesStack[t].element)},PivotView.prototype._updateTablesPosition=function(t){for(var e=0;e<this.tablesStack.length;e++)this.tablesStack[e].element.style.left=100*(1+(t||0)+e-this.tablesStack.length)+"%"},PivotView.prototype.getCurrentTableData=function(){return this.tablesStack[this.tablesStack.length-1]},PivotView.prototype.pushTable=function(t){var e,r=this,a=document.createElement("div");a.className="tableContainer",this.tablesStack.length&&(this.tablesStack[this.tablesStack.length-1].FIXED_COLUMN_SIZES=this.FIXED_COLUMN_SIZES,this.tablesStack[this.tablesStack.length-1].savedSearch=this.savedSearch,this.savedSearch={restore:!1,value:"",columnIndex:0},a.style.left="100%"),this.tablesStack.push({element:a,opts:t||{},pagination:e={on:!1,rows:1/0,page:0,pages:0}}),this.FIXED_COLUMN_SIZES=[],this.elements.base.appendChild(a),this.elements.tableContainer=a,this.pagination=e,setTimeout(function(){r._updateTablesPosition()},30)},PivotView.prototype.popTable=function(){var t;if(!(this.tablesStack.length<2)){this.FIXED_COLUMN_SIZES=[],this._updateTablesPosition(1);var e=this.tablesStack.pop();this.pagination=(t=this.tablesStack[this.tablesStack.length-1]).pagination,t.FIXED_COLUMN_SIZES&&(this.FIXED_COLUMN_SIZES=t.FIXED_COLUMN_SIZES),t.savedSearch&&(this.savedSearch=t.savedSearch),setTimeout(function(){e.element.parentNode.removeChild(e.element)},this.ANIMATION_TIMEOUT),this.elements.tableContainer=this.tablesStack[this.tablesStack.length-1].element}},PivotView.prototype.saveScrollPosition=function(){var t;this.elements.tableContainer&&(t=this.elements.tableContainer.getElementsByClassName("lpt-tableBlock"))&&(this.savedScroll.x=t[0].scrollLeft,this.savedScroll.y=t[0].scrollTop)},PivotView.prototype.restoreScrollPosition=function(){var t;this.elements.tableContainer&&(t=this.elements.tableContainer.getElementsByClassName("lpt-tableBlock"))&&(t[0].scrollLeft=this.savedScroll.x,t[0].scrollTop=this.savedScroll.y)},PivotView.prototype.dataChanged=function(t){var e=t.rawData.length-t.info.topHeaderRowsNumber;this.controller.CONFIG.pagination&&(this.pagination.on=!0),this.pagination.rows=this.controller.CONFIG.pagination||1/0,this.pagination.page=0,this.pagination.pages=Math.ceil(e/this.pagination.rows),this.pagination.pages<2&&(this.pagination.on=!1),this.renderRawData(t)},PivotView.prototype._columnClickHandler=function(t){this.saveScrollPosition(),this.controller.dataController.sortByColumn(t),this.restoreScrollPosition()},PivotView.prototype._rowClickHandler=function(t,e){this.controller.tryDrillDown(e.source.path)},PivotView.prototype._pageSwitcherHandler=function(t){this.pagination.page=t,this.saveScrollPosition(),this.renderRawData(this.controller.dataController.getData()),this.restoreScrollPosition()},PivotView.prototype._backClickHandler=function(t){t&&(t.cancelBubble=!0,t.stopPropagation()),this.removeMessage(),this.popTable(),this.controller.popDataSource(),"function"==typeof this.controller.CONFIG.triggers.back&&this.controller.CONFIG.triggers.back.call(this.controller,{level:this.controller.DRILL_LEVEL})},PivotView.prototype._drillThroughClickHandler=function(t){this.controller.tryDrillThrough(),t&&(t.cancelBubble=!0,t.stopPropagation())},PivotView.prototype._cellClickHandler=function(t,e,r,a,o){var n,i,l=this.controller.dataController.getData(),s=[],c=!0,h=this.controller.CONFIG.showSummary&&this.controller.CONFIG.attachTotals?1:0;try{n=l.rawData[r][l.info.leftHeaderColumnsNumber-1].source.path,i=l.rawData[l.info.topHeaderRowsNumber-1-h][e].source.path}catch(u){console.warn("Unable to get filters for cell (%d, %d)",e,r)}n&&s.push(n),i&&s.push(i),this.controller.CONFIG.drillDownTarget?window.location=location.origin+location.pathname+"?DASHBOARD="+encodeURIComponent(this.controller.CONFIG.drillDownTarget)+"&SETTINGS=FILTER:"+encodeURIComponent(s.join("~"))+";":("function"==typeof this.controller.CONFIG.triggers.cellDrillThrough&&(c=this.controller.CONFIG.triggers.cellDrillThrough({event:a,filters:s,cellData:t})),"function"==typeof o&&(c=!(!1===o({event:a,filters:s,cellData:t})||c===!1)),c!==!1&&this.controller.tryDrillThrough(s))},PivotView.prototype.displayMessage=function(t,e){this.removeMessage();var r=this,a=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div");a.className="central lpt-hoverMessage",a.style.opacity=0,n.innerHTML=t,o.appendChild(n),a.appendChild(o),this.elements.base.appendChild(a),setTimeout(function(){a&&(a.style.opacity=1)},1),e&&a.addEventListener(this.controller.CONFIG.triggerEvent||"click",function(){r.removeMessage()})},PivotView.prototype.removeMessage=function(){var t,e;if((t=this.elements.base.getElementsByClassName("lpt-hoverMessage")).length)for(e in t)t[e].parentNode&&t[e].parentNode.removeChild(t[e])},PivotView.prototype._matchCondition=function(t,e,r){switch(e){case"=":return t==r;case"<>":return t!=r;case">":return t>r;case">=":return t>=r;case"<":return r>t;case"<=":return r>=t;case"IN":return-1!==r.toString().indexOf(t);case"BETWEEN":return t>=r.split(",")[0]&&t<=r.split(",")[1];case"IS NULL":return!t;default:return console.error('Formatting error: unknown format operator "'+e+'"'),!1}},PivotView.prototype.applyConditionalFormatting=function(t,e,r,a){var o,n,i,l,s,c,h=t[""]||[];h=h.concat(t[e]||[]),2===(s=e.split(",")).length&&(h=h.concat(t[s[0]+","]||[],t[","+s[1]]||[]));for(o in h)if(i=h[o],this._matchCondition(r,i.operator,i.value)){if(i.style&&a.setAttribute("style",(a.getAttribute("style")||"")+i.style),i.icon){for(a.textContent="",l='<div style="overflow: hidden; height: 16px;">',c=parseInt(i.iconCount)||1,n=0;c>n;n++)l+='<img alt="*" style="padding-right:2px; height: 100%;" src="'+i.icon+'"/>';a.innerHTML=l+"</div>"}i.text&&(a.textContent=i.text)}},PivotView.prototype.colorNameToRGB=function(t){var e=function(t,e,r){return{r:t,g:e,b:r}};switch(t){case"red":return e(255,0,0);case"green":return e(0,255,0);case"blue":return e(0,0,255);case"purple":return e(102,0,153);case"salmon":return e(255,140,105);case"white":return e(255,255,255);case"black":return e(0,0,0);case"gray":return e(128,128,128);default:return e(255,255,255)}},PivotView.prototype.recalculateSizes=function(t){var e=t.parentNode,r=22;try{var a=this,o=this.controller.CONFIG.triggerEvent||"click",n=window.navigator.userAgent.indexOf("MSIE ")>-1?1/3:0,i=t.getElementsByClassName("lpt-headerValue")[0];if(!i)return;var l=t.getElementsByClassName("lpt-header")[0],s=t.getElementsByClassName("lpt-topHeader")[0],c=t.getElementsByTagName("table")[0],h=c.offsetWidth,u=s.getElementsByTagName("thead")[0],p=t.getElementsByClassName("lpt-leftHeader")[0],d=p.getElementsByTagName("thead")[0],f=t.getElementsByClassName("lpt-tableBlock")[0],m=f.getElementsByTagName("table")[0],g=f.getElementsByTagName("tbody")[0],v=t.getElementsByClassName("lpt-searchInput")[0],S=v?t.offsetWidth-this.SEARCHBOX_LEFT_MARGIN:0,C=f.getElementsByTagName("tr")[0];u.childNodes[0]&&u.childNodes[0].lastChild._extraCell&&u.childNodes[0].removeChild(u.childNodes[0].lastChild),d.lastChild&&d.lastChild._extraTr&&d.removeChild(d.lastChild);var N=(this.pagination.on?this.PAGINATION_BLOCK_HEIGHT:0)+(this.SEARCH_ENABLED?this.PAGINATION_BLOCK_HEIGHT:0),y=Math.max(p.offsetWidth,l.offsetWidth),O=s.offsetHeight;s.style.marginLeft=y+"px";var b=t.offsetHeight,E=b-O-N,_=l.offsetWidth,w=0===d.offsetHeight,T=Math.max(d.offsetHeight,g.offsetHeight)>E&&this.SCROLLBAR_WIDTH>0,D=u.offsetWidth>s.offsetWidth-(T?this.SCROLLBAR_WIDTH:0);!T&&D&&(T=Math.max(d.offsetHeight,g.offsetHeight)>E-this.SCROLLBAR_WIDTH&&this.SCROLLBAR_WIDTH>0);var L,I,x,M=T&&!w,A=[],F=[],R=!1,H=function(){(a.controller.CONFIG.stretchColumns||!T||D)&&(R=!0,I=document.createElement("th"),I.className="lpt-extraCell",I.style.minWidth=a.SCROLLBAR_WIDTH+"px",I.style.width=a.SCROLLBAR_WIDTH+"px",I.rowSpan=u.childNodes.length,I._extraCell=!0,u.childNodes[0].appendChild(I))};if(T&&u.childNodes[0]&&H(),t._primaryColumns)for(x in t._primaryColumns)A.push(t._primaryColumns[x].offsetWidth);else console.warn("No _primaryColumns property in container, cell sizes won't be fixed.");if(t._primaryRows)for(x in t._primaryRows)F.push(t._primaryRows[x].offsetHeight);else console.warn("No _primaryRows property in container, cell sizes won't be fixed.");if(t.parentNode.removeChild(t),s.style.marginLeft=y+"px",f.style.marginLeft=y+"px",p.style.height=b-O-N+"px",p.style.width=y+"px",_>y&&(p.style.width=_+"px"),f.style.height=b-O-N+"px",l.style.height=O+"px",l.style.width=y+"px",this.controller.CONFIG.stretchColumns||(c.style.width="auto",m.style.width=D?"100%":h+"px"),M&&(I=document.createElement("tr"),I.appendChild(L=document.createElement("th")),d.appendChild(I),L.__i=0,L.addEventListener(o,function(){L.__i++,L.style.background="#"+Math.max(18-3*L.__i,0).toString(16)+"FF7D7",L.__i>5&&a._()}),I._extraTr=!0,L.colSpan=d.childNodes.length,L.style.height=(this.SCROLLBAR_WIDTH?this.SCROLLBAR_WIDTH+1:0)+"px"),v&&(v.style.width=S+"px"),C)for(x in C.childNodes)"TD"===C.childNodes[x].tagName&&(C.childNodes[x].style.width=A[x]+"px");for(x in g.childNodes)"TR"===g.childNodes[x].tagName&&g.childNodes[x].firstChild&&(g.childNodes[x].firstChild.style.height=(F[x]||F[x-1]||r)+n+"px");e.appendChild(t),Math.max(d.offsetHeight,g.offsetHeight)>E&&this.SCROLLBAR_WIDTH>0&&!R&&H()}catch(P){console.error("Error when fixing sizes.","ERROR:",P)}},PivotView.prototype.renderRawData=function(t){if(!t.rawData||!t.rawData[0]||!t.rawData[0][0])return void this.displayMessage("<h1>"+pivotLocale.get(1)+"</h1><p>"+JSON.stringify(t)+"</p>");var e,r,a,o,n,i,l,s,c,h,u,p=this,d=t.rawData,f=t.info,m=t.columnProps,g=t.conditionalFormatting?t.conditionalFormatting.colorScale:void 0,v=this.controller.CONFIG.triggerEvent||"click",S=f.SUMMARY_SHOWN&&this.controller.CONFIG.attachTotals?1:0,C=!!this.controller.CONFIG.columnResizing,N=0===f.leftHeaderColumnsNumber,y=N&&this.controller.CONFIG.enableSearch,O=this.elements.tableContainer,b=document.createElement("div"),E=document.createElement("div"),_=document.createElement("div"),w=document.createElement("div"),T=document.createElement("div"),D=document.createElement("div"),L=document.createElement("div"),I=document.createElement("table"),x=document.createElement("thead"),M=document.createElement("table"),A=document.createElement("thead"),F=document.createElement("table"),R=document.createElement("tbody"),H=this.pagination.on?document.createElement("div"):null,P=this.pagination.on?[]:null,k=H?document.createElement("div"):null,G=y?document.createElement("div"):null,B=y?document.createElement("span"):null,U=y?document.createElement("select"):null,W=y?document.createElement("span"):null,V=y?document.createElement("input"):null,X=y?function(){for(var t=[],e=f.leftHeaderColumnsNumber,r=f.topHeaderRowsNumber-1-S,a=e;a<d[r].length;a++)t.push({value:d[r][a].value,source:d[r][a].source,columnIndex:a});return t}():null,z=!1,Y=null,Z=0,$={},j=null,K=[],J=[];this.SEARCH_ENABLED=y,this.numeral.setup(f.decimalSeparator||".",f.numericGroupSeparator||",",f.numericGroupSize||3);var q=function(t,e,r){isFinite(t)?e.textContent=r?t?p.numeral(t).format(r):"":t&&f.defaultFormat?p.numeral(t).format(t%1===0?"#,###":"#,###.##"):t||"":(e.className+=" formatLeft",e.textContent=t||"")},Q=function(t,e){var r;t.createTextRange?(r=t.createTextRange(),r.move("character",e),r.select()):t.setSelectionRange(e,e)},te=function(t,a){var o=t,n=a,i=function(t){z&&(t.cancelBubble=!0,t.preventDefault(),Y.style.width=Y.style.minWidth=e-r+t.pageX+"px")};o._HAS_MOUSE_MOVE_LISTENER||(o.parentNode.addEventListener("mousemove",i),o._HAS_MOUSE_MOVE_LISTENER=!0),o.addEventListener("mousedown",function(t){(t.target||t.srcElement)===o&&(t.cancelBubble=!0,t.preventDefault(),z=!0,Y=o,e=o.offsetWidth,r=t.pageX,Z=n)}),o.addEventListener("mouseup",function(t){z&&(t.cancelBubble=!0,t.preventDefault(),z=!1,Y.style.width=Y.style.minWidth=(p.FIXED_COLUMN_SIZES[Z]=e-r+t.pageX)+"px",p.saveScrollPosition(),p.recalculateSizes(O),p.restoreScrollPosition(),setTimeout(function(){Y=null},1))})};for(this.removeMessage();O.firstChild;)O.removeChild(O.firstChild);var ee=function(t,e,r,a,i){var l,s,c,h,u,g=i===A;for(n=r;a>n;n++){for(o=t;e>o;o++)s=!0,(l=$.hasOwnProperty(d[n][o].group))&&(o>0&&d[n][o-1].group===d[n][o].group&&(s=!1,$[d[n][o].group].element.colSpan=o-$[d[n][o].group].x+1),n>0&&d[n-1][o].group===d[n][o].group&&(s=!1,$[d[n][o].group].element.rowSpan=n-$[d[n][o].group].y+1),h=$[d[n][o].group].element),(!l||s)&&(c||(c=document.createElement("tr")),c.appendChild(h=document.createElement(d[n][o].isCaption?"th":"td")),u=document.createElement("div"),d[n][o].value?u.textContent=d[n][o].value:u.innerHTML="&nbsp;",h.appendChild(u),d[n][o].style&&h.setAttribute("style",d[n][o].style),0===f.leftHeaderColumnsNumber&&p.controller.CONFIG.listingColumnMinWidth&&(h.style.minWidth=p.controller.CONFIG.listingColumnMinWidth+"px"),f.leftHeaderColumnsNumber>0&&p.controller.CONFIG.maxHeaderWidth&&(h.style.maxWidth=p.controller.CONFIG.maxHeaderWidth+"px",h.style.whiteSpace="normal",h.style.wordWrap="normal"),d[n][o].className&&(h.className=d[n][o].className),d[n][o].group&&($[d[n][o].group]={x:o,y:n,element:h}),d[n][o].isCaption||q(d[n][o].value,h,m[o-f.leftHeaderColumnsNumber].format)),g&&o===e-1&&!d[n][o].noDrillDown&&(J.push(h),h.addEventListener(v,function(t,e){return function(){p._rowClickHandler.call(p,t,e)}}(n,d[n][o]))),g||n!==a-1-S||h._hasSortingListener||(h._hasSortingListener=!1,h.addEventListener(v,function(t){return function(){p._columnClickHandler.call(p,t)}}(o-f.leftHeaderColumnsNumber)),h.className=(h.className||"")+" lpt-clickable"),g||n!==a-1||(p.FIXED_COLUMN_SIZES[o]&&(h.style.minWidth=h.style.width=p.FIXED_COLUMN_SIZES[o]+"px"),C&&(te(h,o),h.className+=" lpt-resizableColumn"),K.push(h));c&&i.appendChild(c),c=null}};for(T.textContent=f.leftHeaderColumnsNumber?d[0][0].value:"",d[0][0].style&&T.setAttribute("style",d[0][0].style),this.tablesStack.length>1&&!this.controller.CONFIG.hideButtons&&(T.className+="back ",T.addEventListener(v,function(t){p._backClickHandler.call(p,t)})),f.leftHeaderColumnsNumber>0&&p.controller.CONFIG.maxHeaderWidth&&(_.style.maxWidth=p.controller.CONFIG.maxHeaderWidth*f.leftHeaderColumnsNumber+"px",_.style.whiteSpace="normal",_.style.wordWrap="normal"),(this.controller.CONFIG.hideButtons||this.tablesStack.length<2)&&0===f.leftHeaderColumnsNumber&&(T.style.display="none"),ee(f.leftHeaderColumnsNumber,d[0].length,0,f.topHeaderRowsNumber,x),ee(0,f.leftHeaderColumnsNumber,c=f.topHeaderRowsNumber+(this.pagination.page*this.pagination.rows||0),h=this.pagination.on?Math.min(c+this.pagination.rows,d.length):d.length,A),n=c;h>n;n++){for(j=document.createElement("tr"),o=f.leftHeaderColumnsNumber;o<d[0].length;o++)s=this.controller.getPivotProperty(["cellStyle"])||"",j.appendChild(i=document.createElement("td")),i.appendChild(u=document.createElement("div")),q(d[n][o].value,u,m[o-f.leftHeaderColumnsNumber].format),!g||f.SUMMARY_SHOWN&&d.length-1===n||(l=(parseFloat(d[n][o].value)-g.min)/g.diff,s+="background:rgb("+ +Math.round((g.to.r-g.from.r)*l+g.from.r)+","+Math.round((g.to.g-g.from.g)*l+g.from.g)+","+Math.round((g.to.b-g.from.b)*l+g.from.b)+");"+(g.invert?"color: white;":"")),m[o-f.leftHeaderColumnsNumber].style&&(s+=m[o-f.leftHeaderColumnsNumber].style),d[n][o].style&&(s+=d[n][o].style),!this.controller.CONFIG.conditionalFormattingOn||f.SUMMARY_SHOWN&&d.length-1===n||this.getCurrentTableData().opts.disableConditionalFormatting||this.applyConditionalFormatting(t.conditionalFormatting,n-f.topHeaderRowsNumber+1+","+(o-f.leftHeaderColumnsNumber+1),d[n][o].value,u),s&&i.setAttribute("style",(i.getAttribute("style")||"")+s),i.addEventListener(v,function(t,e,r){return function(a){p._cellClickHandler.call(p,r,t,e,a,f.drillThroughHandler)}}(o,n,d[n][o]));R.appendChild(j)}if(L.addEventListener("scroll",function(){return L._ISE?void(L._ISE=!1):(w.scrollLeft=L.scrollLeft,D.scrollTop=L.scrollTop,w._ISE=!0,void(D._ISE=!0))}),D.className="lpt-leftHeader",w.className="lpt-topHeader",this.controller.CONFIG.enableHeadersScrolling&&(D.className=D.className+" lpt-scrollable-y",w.className=w.className+" lpt-scrollable-x",D.addEventListener("scroll",function(){return D._ISE?void(D._ISE=!1):(L.scrollTop=D.scrollTop,void(L._ISE=!0))}),w.addEventListener("scroll",function(){return w._ISE?void(w._ISE=!1):(L.scrollLeft=w.scrollLeft,void(L._ISE=!0))})),L.className="lpt-tableBlock",_.className="lpt-header",b.className="lpt-topSection",E.className="lpt-bottomSection",T.className+="lpt-headerValue",F.appendChild(R),L.appendChild(F),M.appendChild(A),D.appendChild(M),I.appendChild(x),w.appendChild(I),_.appendChild(T),b.appendChild(_),b.appendChild(w),E.appendChild(D),E.appendChild(L),O.appendChild(b),O.appendChild(E),this.controller.CONFIG.stretchColumns||(I.style.width="auto"),H){H.className="lpt-pageSwitcher",P=function(t,e){for(var r=0,a=[t];t>1;)t=Math.max(1,t-(r||1)),a.unshift(t),r=r*r+1;for(r=0,t=a[a.length-1];e>t;)t=Math.min(e,t+(r||1)),a.push(t),r=r*r+1;return a}(this.pagination.page+1,this.pagination.pages);for(a in P)a=parseInt(a),i=document.createElement("span"),P[a]===this.pagination.page+1&&(i.className="lpt-active"),i.textContent=P[a],function(t){i.addEventListener(v,function(){p._pageSwitcherHandler.call(p,t-1)})}(P[a]),k.appendChild(i),P[a+1]&&P[a]+1!==P[a+1]&&(i=document.createElement("span"),i.className="lpt-pageSpacer",k.appendChild(i));H.appendChild(k),O.appendChild(H)}if(y){B.className="lpt-searchIcon",W.className="lpt-searchSelectOuter",G.className="lpt-searchBlock",V.className="lpt-searchInput",U.className="lpt-searchSelect";for(a in X)i=document.createElement("option"),i.setAttribute("value",X[a].columnIndex.toString()),i.textContent=X[a].value,U.appendChild(i);V.addEventListener("input",function(){var t=parseInt(U.options[U.selectedIndex].value),e=V.value;p.saveScrollPosition(),p.savedSearch.value=e,p.savedSearch.columnIndex=t,p.savedSearch.restore=!0,p.controller.dataController.filterByValue(e,t),p.restoreScrollPosition()}),G.appendChild(B),W.appendChild(U),G.appendChild(W),G.appendChild(V),O.insertBefore(G,b),this.elements.searchInput=V,this.elements.searchSelect=U,this.savedSearch.restore&&(this.elements.searchInput.value=this.savedSearch.value,this.elements.searchSelect.value=this.savedSearch.columnIndex)}else this.elements.searchInput=void 0,this.elements.searchSelect=void 0;O._primaryColumns=K,O._primaryRows=J,this.recalculateSizes(O),this.savedSearch.restore&&(this.elements.searchInput.focus(),Q(this.elements.searchInput,this.savedSearch.value.length))},LightPivotTable}();